<!-- templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/css/style.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="dashboard">
    <!-- Left: big clock -->
    <div class="clock-section card">
      <div id="clock" class="clock">--:--</div>
      <div id="date" class="date">--</div>
    </div>

    <!-- Top-right: Bus info -->
    <div class="bus-section card">
      <div id="bus-list" class="bus-list">
        <!-- arrivals injected here -->
      </div>
      <div class="bus-footer">
        <div class="updated" id="bus-updated">Data updated â€”</div>
      </div>
    </div>

    <!-- Bottom: Weather -->
    <div class="weather-section card">
      <div class="weather-top">
        <div class="weather-left">
          <div class="weather-current">
            <img id="w-icon" src="" alt="icon">
            <div>
              <div id="w-cond" class="w-cond">Loadingâ€¦</div>
              <div id="w-temp" class="w-temp">--Â°F</div>
              <div id="w-feels" class="w-feels">Feels --Â°F</div>
            </div>
          </div>
        </div>
        <div class="weather-right">
          <div id="w-daily-avg" class="w-avg">Avg: --Â°F</div>
          <div id="w-sun" class="w-sun">Sun: --</div>
        </div>
      </div>

      <div class="hourly-strip" id="hourly-strip">
        <!-- hourly cards injected here -->
      </div>
    </div>
  </div>

<script>
/* Clock tick (client-side) */
function tickClock() {
  const d = new Date();
  const time = d.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit', hour12: true});
  const date = d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
  document.getElementById('clock').textContent = time;
  document.getElementById('date').textContent = date;
}
setInterval(tickClock, 1000);
tickClock();

/* Fetch weather from Worker endpoint */
async function loadWeather() {
  try {
    const res = await fetch("/api/weather");
    const j = await res.json();
    if (!j) return;

    const cur = j.current || {};
    document.getElementById('w-icon').src = cur.icon || '';
    document.getElementById('w-cond').textContent = cur.label || (cur.code ? `Code ${cur.code}` : 'Weather');
    document.getElementById('w-temp').textContent = cur.temp != null ? `${Math.round(cur.temp)}Â°F` : '--Â°F';
    document.getElementById('w-feels').textContent = cur.feels_like != null ? `Feels ${Math.round(cur.feels_like)}Â°F` : 'Feels --Â°F';

    document.getElementById('w-daily-avg').textContent = j.daily_avg ? `Avg: ${j.daily_avg}Â°F` : 'Avg: --';
    const sun = j.sun || {};
    document.getElementById('w-sun').textContent = `${sun.label || 'Sun'}: ${sun.time || '--'}`;

    const strip = document.getElementById('hourly-strip');
    strip.innerHTML = '';
    (j.hourly || []).forEach(h => {
      const el = document.createElement('div');
      el.className = 'hour-card';
      el.innerHTML = `
        <div class="hour-time">${h.time || '--'}</div>
        <img class="hour-icon" src="${h.icon || ''}" alt="">
        <div class="hour-temp">${h.temp != null ? Math.round(h.temp) + 'Â°' : '--'}</div>
        <div class="hour-rain">ðŸŒ§ ${h.rain ?? 0}%</div>
      `;
      strip.appendChild(el);
    });
  } catch(err) {
    console.error("Weather fetch error:", err);
  }
}

/* Fetch bus data from Worker endpoint */
async function loadBus() {
  try {
    const res = await fetch("/api/bus");
    const j = await res.json();
    const list = document.getElementById('bus-list');
    list.innerHTML = '';

    if (j.hidden) {
      document.getElementById('bus-updated').textContent = '';
      const msg = document.createElement('div');
      msg.className = 'muted';
      msg.style.textAlign = 'center';
      msg.style.padding = '90px';
      msg.textContent = `ðŸšŒ Scheduled for ${j.scheduled_for}`;
      list.appendChild(msg);
      return;
    }

    if (!j.buses) {
      list.innerHTML = `<div class="muted">Bus data unavailable</div>`;
      return;
    }

    document.getElementById('bus-updated').textContent = 'Data updated ' + (new Date()).toLocaleTimeString();

    for (const line of ['Q44-SBS','Q20']) {
      if (j.buses[line] && j.buses[line].length) {
        const header = document.createElement('div');
        header.className = 'bus-group-header';
        header.textContent = line;
        list.appendChild(header);

        j.buses[line].forEach(b => {
          const li = document.createElement('div');
          li.className = 'bus-item';
          const minutes = b.minutes != null ? b.minutes : '?';
          li.innerHTML = `<div class="route">${b.line}</div>
                          <div class="detail">ðŸšŒ ${minutes} min â€¢ ${b.dest}${b.extra || ''}</div>`;
          list.appendChild(li);
        });
      }
    }

  } catch(err) {
    console.error("Bus fetch error:", err);
  }
}

// Initial load
loadWeather();
loadBus();
setInterval(loadWeather, 5 * 60 * 1000); // every 5 min
setInterval(loadBus, 15 * 1000); // every 15 sec
</script>
</body>
</html>
